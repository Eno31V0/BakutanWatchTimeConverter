<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã°ããŸã‚“ã€‚ARCHIVESåŠã³åŒæ™‚è¦–è´ã®å†ç”Ÿæ™‚åˆ»ã‚’ç›¸äº’å¤‰æ›ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«">
    <meta name="generator" content="ChatGPT">
    <title>ã°ããŸã‚“ã€‚ARCHIVES-åŒæ™‚è¦–è´ å†ç”Ÿæ™‚åˆ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        select,
        input,
        button {
            margin: 10px;
            padding: 5px;
        }

        h3 {
            margin-top: 20px;
        }
    </style>
    <link rel="me" href="https://github.com/Eno31V0/BakutanWatchTimeConverter/issues" type="">
    <link rel="me" href="https://x.com/ItMayBeEno" type="">
</head>

<body>

    <h1>ã°ããŸã‚“ã€‚ARCHIVES-åŒæ™‚è¦–è´ å†ç”Ÿæ™‚åˆ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>

    <label for="archiveSelect">æ¼”ç›®:</label>
    <select id="archiveSelect"></select> <!-- JSONã‹ã‚‰å‹•çš„ã«é¸æŠè‚¢ã‚’è¿½åŠ  -->

    <br>

    <label for="extraOffset">è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆ (ç§’):</label>
    <input type="number" id="extraOffset" value="0">

    <br>

    <label for="archiveTime">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å†ç”Ÿæ™‚åˆ» (hh:mm:ss):</label>
    <input type="time" id="archiveTime" step="1" value="00:00:00">

    <br>

    <label for="groupWatchTime">åŒæ™‚è¦–è´ã®å†ç”Ÿæ™‚åˆ» (hh:mm:ss):</label>
    <input type="time" id="groupWatchTime" step="1" value="00:00:00">

    <br>

    <details>
        <summary>ã‚ªãƒ•ã‚»ãƒƒãƒˆæƒ…å ±(å·¥äº‹ä¸­)</summary>

        <p>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–0ç§’æ™‚ç‚¹ã§ã®åŒæ™‚è¦–è´å†ç”Ÿæ™‚åˆ»: <span id="offsetDisplay">00:00:00</span></p>
        <ul id="cutPartList" style="display: none;"></ul> <!-- ã‚«ãƒƒãƒˆã•ã‚ŒãŸãƒ‘ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ãƒªã‚¹ãƒˆ -->

    </details>

    <button onclick="window.open(currentArchive.archiveURL, '_blank')">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸ç§»å‹•</button>
    <button onclick="window.open(currentArchive.groupWatchURL, '_blank')">åŒæ™‚è¦–è´ã¸ç§»å‹•</button>

    <br>
    <button onclick="window.open('https://forms.gle/Y8yAge8Rwt7qeANb6', '_blank')">å•ã„åˆã‚ã›ç­‰ã¯ã“ã¡ã‚‰</button>

    <p>
        ãã®ä»–é€£çµ¡å…ˆ
        <a href="https://github.com/Eno31V0/BakutanWatchTimeConverter/issues" target="_blank"
            rel="noopener noreferrer">GitHub Issues</a>
        <a href="https://x.com/ItMayBeEno" target="_blank" rel="noopener noreferrer">ğ•</a>
    </p>

    <script>
        const jsonUrl = "https://raw.githubusercontent.com/Eno31v0/BakutanWatchTimeConverter/main/archives.json";
        let archives = {};
        let currentArchive;

        function decodeTimeString(timeStr) {
            let [hours, minutes, seconds] = timeStr.split(":").map(Number);
            let playTimeInSeconds = hours * 3600 + minutes * 60 + seconds;
            return playTimeInSeconds;
        }

        function encodeTimeString(second) {
            let adjustedHours = Math.floor(second / 3600);
            let adjustedMinutes = Math.floor((second % 3600) / 60);
            let adjustedSeconds = second % 60;

            let groupWatchTimeStr = `${String(adjustedHours).padStart(2, '0')}:${String(adjustedMinutes).padStart(2, '0')}:${String(adjustedSeconds).padStart(2, '0')}`;

            return groupWatchTimeStr;
        }

        async function fetchOffsets() {
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error("JSONã®å–å¾—ã«å¤±æ•—");
                archives = (await response.json()).archives;

                archives.unshift({
                    "name": "â–¼ä»¥ä¸‹ã‹ã‚‰é¸æŠ",
                    "offset": 0,
                    "archiveURL": "https://bakutan.natorisana.com/",
                    "groupWatchURL": "https://www.youtube.com/@sana_natori"
                });

                // JSONãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«é¸æŠè‚¢ã‚’å‹•çš„ã«ä½œæˆ
                let selectElement = document.getElementById("archiveSelect");
                selectElement.innerHTML = "";  // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                archives.forEach(preset => {
                    let option = document.createElement("option");
                    option.value = preset.name;
                    option.textContent = preset.name;
                    selectElement.appendChild(option);
                });

                //onArchiveSelectChanged();
                //selectElement.value = "â–¼ä»¥ä¸‹ã‹ã‚‰é¸æŠ";
                currentArchive = archives[0];
            } catch (error) {
                console.error("JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        function calculateGWT(event) {
            if (!currentArchive) return;
            let playTimeStr = document.getElementById("archiveTime").value;

            //if (!playTimeStr) {
            //    document.getElementById("result").textContent = "--:--:--";
            //    return;
            //}

            let playTimeInSeconds = decodeTimeString(playTimeStr);

            // è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            let extraOffset = parseInt(document.getElementById("extraOffset").value) || 0;

            // åŸºæœ¬ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            //let offsetToApply = currentArchive.offset;
            let offsetToApply = decodeTimeString(currentArchive.offset);

            // ç‰¹å®šã®æ™‚åˆ»ã‚’è¶…ãˆãŸå ´åˆã«æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            if (currentArchive.timeOffsets && currentArchive.timeOffsets.length > 0) {
                for (let timeOffset of currentArchive.timeOffsets) {
                    let switchTimeInSeconds = decodeTimeString(timeOffset.switchTime);

                    if (playTimeInSeconds >= switchTimeInSeconds) {
                        //offsetToApply = timeOffset.newOffset;
                        offsetToApply = decodeTimeString(timeOffset.newOffset);
                    }
                }
            }

            let totalOffset = offsetToApply + extraOffset;
            let adjustedTimeInSeconds = playTimeInSeconds + totalOffset;

            if (adjustedTimeInSeconds < 0) {
                document.getElementById("groupWatchTime").value = "00:00:00";
                return;
            }

            let groupWatchTime = encodeTimeString(adjustedTimeInSeconds);

            // çµæœã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById("groupWatchTime").value = groupWatchTime;
        }

        function calculateAT(event) {
            if (!currentArchive) return;
            let playTimeStr = document.getElementById("groupWatchTime").value;

            let playTimeInSeconds = decodeTimeString(playTimeStr);

            // è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            let extraOffset = parseInt(document.getElementById("extraOffset").value) || 0;

            // åŸºæœ¬ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            //let offsetToApply = currentArchive.offset;
            let offsetToApply = decodeTimeString(currentArchive.offset);

            // ç‰¹å®šã®æ™‚åˆ»ã‚’è¶…ãˆãŸå ´åˆã«æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            if (currentArchive.timeOffsets && currentArchive.timeOffsets.length > 0) {
                for (let timeOffset of currentArchive.timeOffsets) {
                    let switchTimeInSeconds = decodeTimeString(timeOffset.switchTime);

                    if (playTimeInSeconds >= switchTimeInSeconds) {
                        //offsetToApply = timeOffset.newOffset;
                        offsetToApply = decodeTimeString(timeOffset.newOffset);
                    }
                }
            }

            let totalOffset = offsetToApply + extraOffset;
            let adjustedTimeInSeconds = playTimeInSeconds - totalOffset;

            if (adjustedTimeInSeconds < 0) {
                document.getElementById("archiveTime").value = "00:00:00";
                return;
            }

            let groupWatchTime = encodeTimeString(adjustedTimeInSeconds);

            // çµæœã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById("archiveTime").value = archiveTime;
        }

        function onArchiveSelectChanged(event) {
            let archiveName = document.getElementById("archiveSelect").value;
            currentArchive = archives.find(p => p.name === archiveName);
            if (!currentArchive) return;

            document.getElementById("offsetDisplay").textContent = currentArchive.offset;

            calculateGWT();
        }

        function isPC() {
            return !/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        }
        if (!isPC()) {
            alert("æœ¬ãƒšãƒ¼ã‚¸ã¯PCã§ã®ä½¿ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚\nç¾åœ¨ã®ä½¿ç”¨ãƒ‡ãƒã‚¤ã‚¹ã§ã¯æ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒé«˜ã„äº‹ã‚’ã”äº†æ‰¿ä¸‹ã•ã„ã€‚\n(ç‰¹ã«iOSã§ã¯å‹•ä½œä¸å¯ç¢ºèªæ¸ˆ)");
        }

        document.getElementById("archiveSelect").addEventListener("change", onArchiveSelectChanged);
        document.getElementById("extraOffset").addEventListener("input", calculateGWT);
        document.getElementById("archiveTime").addEventListener("input", calculateGWT);
        document.getElementById("groupWatchTime").addEventListener("input", calculateAT);

        fetchOffsets();

    </script>

</body>

</html>