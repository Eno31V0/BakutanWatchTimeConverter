<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ™‚è¦–è´-ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†ç”Ÿæ™‚åˆ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        select,
        input,
        button {
            margin: 10px;
            padding: 5px;
        }

        h3 {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <h2>åŒæ™‚è¦–è´-ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†ç”Ÿæ™‚åˆ»å¤‰æ›ãƒ„ãƒ¼ãƒ«</h2>

    <label for="archiveSelect">æ¼”ç›®:</label>
    <select id="archiveSelect"></select> <!-- JSONã‹ã‚‰å‹•çš„ã«é¸æŠè‚¢ã‚’è¿½åŠ  -->

    <br>

    <label for="extraOffset">è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆ (ç§’):</label>
    <input type="number" id="extraOffset" value="0">

    <br>

    <label for="archiveTime">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å†ç”Ÿæ™‚åˆ» (hh:mm:ss):</label>
    <input type="time" id="archiveTime" step="1" value="00:00:00">

    <br>

    <label for="groupWatchTime">åŒæ™‚è¦–è´ã®å†ç”Ÿæ™‚åˆ» (hh:mm:ss):</label>
    <input type="time" id="groupWatchTime" step="1" value="00:00:00">

    <br>

    <button id="archiveButton">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸ç§»å‹•</button>
    <button id="groupWatchButton">åŒæ™‚è¦–è´ã¸ç§»å‹•</button>

    <br>
    <button onclick="window.open('https://forms.gle/Y8yAge8Rwt7qeANb6', '_blank')">å•ã„åˆã‚ã›ç­‰ã¯ã“ã¡ã‚‰</button>
    <p>ãã®ä»–é€£çµ¡å…ˆ <a href="https://github.com/Eno31V0/BakutanWatchTimeConverter/issues">GitHub Issues</a> <a href="https://x.com/ItMayBeEno">ğ•</a></p>

    <script>
        const jsonUrl = "https://raw.githubusercontent.com/Eno31v0/WebPageLearn/main/archives.json";
        let offsets = {};
        let currentArchive;

        async function fetchOffsets() {
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error("JSONã®å–å¾—ã«å¤±æ•—");
                offsets = await response.json();

                offsets.presets.unshift({
                    "name": "â–¼ä»¥ä¸‹ã‹ã‚‰é¸æŠ",
                    "offset": 0,
                    "archiveURL": "https://bakutan.natorisana.com/",
                    "groupWatchURL": "https://www.youtube.com/@sana_natori"
                });

                // JSONãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«é¸æŠè‚¢ã‚’å‹•çš„ã«ä½œæˆ
                let selectElement = document.getElementById("archiveSelect");
                selectElement.innerHTML = "";  // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                offsets.presets.forEach(preset => {
                    let option = document.createElement("option");
                    option.value = preset.name;
                    option.textContent = preset.name;
                    selectElement.appendChild(option);
                });

                onArchiveChanged();
            } catch (error) {
                console.error("JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        function calculateGWT() {
            let presetName = document.getElementById("archiveSelect").value;
            let preset = offsets.presets.find(p => p.name === presetName);
            if (!preset) return;

            let playTimeStr = document.getElementById("archiveTime").value;

            //if (!playTimeStr) {
            //    document.getElementById("result").textContent = "--:--:--";
            //    return;
            //}

            let [hours, minutes, seconds] = playTimeStr.split(":").map(Number);
            let playTimeInSeconds = hours * 3600 + minutes * 60 + seconds;

            // è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            let extraOffset = parseInt(document.getElementById("extraOffset").value) || 0;

            // åŸºæœ¬ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            let offsetToApply = preset.offset;

            // ç‰¹å®šã®æ™‚åˆ»ã‚’è¶…ãˆãŸå ´åˆã«æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            if (preset.timeOffsets && preset.timeOffsets.length > 0) {
                for (let timeOffset of preset.timeOffsets) {
                    let [switchHours, switchMinutes, switchSeconds] = timeOffset.switchTime.split(":").map(Number);
                    let switchTimeInSeconds = switchHours * 3600 + switchMinutes * 60 + switchSeconds;

                    if (playTimeInSeconds >= switchTimeInSeconds) {
                        offsetToApply = timeOffset.newOffset;
                    }
                }
            }

            let totalOffset = offsetToApply + extraOffset;
            let adjustedTimeInSeconds = playTimeInSeconds + totalOffset;

            if (adjustedTimeInSeconds < 0) {
                document.getElementById("groupWatchTime").value = "00:00:00";
                return;
            }

            let adjustedHours = Math.floor(adjustedTimeInSeconds / 3600);
            let adjustedMinutes = Math.floor((adjustedTimeInSeconds % 3600) / 60);
            let adjustedSeconds = adjustedTimeInSeconds % 60;

            let groupWatchTime = `${String(adjustedHours).padStart(2, '0')}:${String(adjustedMinutes).padStart(2, '0')}:${String(adjustedSeconds).padStart(2, '0')}`;

            // çµæœã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById("groupWatchTime").value = groupWatchTime;
        }

        function calculateAT() {
            let presetName = document.getElementById("archiveSelect").value;
            let preset = offsets.presets.find(p => p.name === presetName);
            if (!preset) return;

            let playTimeStr = document.getElementById("groupWatchTime").value;

            let [hours, minutes, seconds] = playTimeStr.split(":").map(Number);
            let playTimeInSeconds = hours * 3600 + minutes * 60 + seconds;

            // è¿½åŠ ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            let extraOffset = parseInt(document.getElementById("extraOffset").value) || 0;

            // åŸºæœ¬ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            let offsetToApply = preset.offset;

            // ç‰¹å®šã®æ™‚åˆ»ã‚’è¶…ãˆãŸå ´åˆã«æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨
            if (preset.timeOffsets && preset.timeOffsets.length > 0) {
                for (let timeOffset of preset.timeOffsets) {
                    let [switchHours, switchMinutes, switchSeconds] = timeOffset.switchTime.split(":").map(Number);
                    let switchTimeInSeconds = switchHours * 3600 + switchMinutes * 60 + switchSeconds;

                    if (playTimeInSeconds >= switchTimeInSeconds) {
                        offsetToApply = timeOffset.newOffset;
                    }
                }
            }

            let totalOffset = offsetToApply + extraOffset;
            let adjustedTimeInSeconds = playTimeInSeconds - totalOffset;

            if (adjustedTimeInSeconds < 0) {
                document.getElementById("archiveTime").value = "00:00:00";
                return;
            }

            let adjustedHours = Math.floor(adjustedTimeInSeconds / 3600);
            let adjustedMinutes = Math.floor((adjustedTimeInSeconds % 3600) / 60);
            let adjustedSeconds = adjustedTimeInSeconds % 60;

            let archiveTime = `${String(adjustedHours).padStart(2, '0')}:${String(adjustedMinutes).padStart(2, '0')}:${String(adjustedSeconds).padStart(2, '0')}`;

            // çµæœã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
            document.getElementById("archiveTime").value = archiveTime;
        }

        function onArchiveChanged() {
            let presetName = document.getElementById("archiveSelect").value;
            currentArchive = offsets.presets.find(p => p.name === presetName);
            if (!currentArchive) return;

            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆã®URLã‚’å–å¾—
            let archiveURL = currentArchive.archiveURL;
            let groupWatchURL = currentArchive.groupWatchURL;

            // URLé·ç§»ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’æ›´æ–°
            let archiveButton = document.getElementById("archiveButton");
            archiveButton.onclick = function () {
                window.open(archiveURL, '_blank');  // é¸æŠã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆã®URLã«é·ç§»
            };
            let groupWatchButton = document.getElementById("groupWatchButton");
            groupWatchButton.onclick = function () {
                window.open(groupWatchURL, '_blank');  // é¸æŠã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆã®URLã«é·ç§»
            };

            calculateGWT();
        }

        document.getElementById("archiveSelect").addEventListener("change", onArchiveChanged);
        document.getElementById("extraOffset").addEventListener("input", calculateGWT);
        document.getElementById("archiveTime").addEventListener("input", calculateGWT);
        document.getElementById("groupWatchTime").addEventListener("input", calculateAT);

        fetchOffsets();

    </script>

</body>

</html>